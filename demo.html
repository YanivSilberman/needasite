<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>needasite - Build & Edit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  
  <!-- Initial Build Screen -->
  <div id="buildScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="w-full max-w-lg">
      <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8">
        <div class="text-center mb-6">
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">needasite</h1>
          <p class="text-gray-500 mt-1">Describe it. We'll build it.</p>
        </div>

        <form id="buildForm" class="space-y-4">
          <textarea
            id="initialPrompt"
            rows="4"
            placeholder="A portfolio website for a photographer named Alex who specializes in landscape photography..."
            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
            required
          ></textarea>
          <button type="submit" id="buildBtn" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition disabled:opacity-50">
            Build My Site
          </button>
        </form>

        <div id="buildLoading" class="hidden flex-col items-center py-8">
          <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
          <p id="loadingText" class="text-gray-600">Building your site...</p>
          <p class="text-gray-400 text-sm mt-1">~30 seconds (generating custom images)</p>
        </div>

        <div id="buildError" class="hidden mt-6 p-4 bg-red-50 rounded-xl text-red-700">
          <span id="buildErrorMsg"></span>
          <button onclick="resetBuild()" class="mt-2 text-sm underline">Try again</button>
        </div>
      </div>
      <p class="text-center text-white/60 text-sm mt-6">Powered by Gemini + Imagen</p>
    </div>
  </div>

  <!-- Editor Screen -->
  <div id="editorScreen" class="hidden min-h-screen flex flex-col">
    
    <!-- Top Bar -->
    <div class="bg-white border-b px-4 py-3 flex items-center justify-between">
      <h1 class="font-bold text-gray-900">needasite</h1>
      <div class="flex gap-2">
        <button id="togglePreview" class="px-3 py-1.5 text-sm bg-purple-100 text-purple-700 rounded-lg font-medium">
          Preview
        </button>
        <button id="downloadSite" class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg font-medium">
          Download
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
      
      <!-- Chat Panel -->
      <div id="chatPanel" class="flex-1 flex flex-col bg-gray-50 lg:max-w-md lg:border-r">
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <div class="p-4 bg-white border-t">
          <form id="chatForm" class="flex gap-2">
            <input type="text" id="chatInput" placeholder="Make the header blue..."
              class="flex-1 px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-medium">Send</button>
          </form>
        </div>
      </div>

      <!-- Preview Panel -->
      <div id="previewPanel" class="hidden lg:flex flex-1 flex-col bg-white">
        <div class="flex-1 overflow-hidden">
          <iframe id="previewFrame" class="w-full h-full border-0"></iframe>
        </div>
      </div>
    </div>

    <!-- Mobile Preview Modal -->
    <div id="mobilePreview" class="hidden fixed inset-0 z-50 bg-black/50">
      <div class="h-full flex flex-col">
        <div class="bg-white px-4 py-3 flex items-center justify-between">
          <span class="font-medium">Preview</span>
          <button onclick="closeMobilePreview()" class="text-gray-500">âœ•</button>
        </div>
        <iframe id="mobilePreviewFrame" class="flex-1 bg-white"></iframe>
      </div>
    </div>
  </div>

  <script>
    const GEMINI_KEY = 'AIzaSyCt6kF7rVw--3CzfmmAuyTVYYzaNwrrKWY';
    const GEMINI_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
    const IMAGEN_API = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-fast-generate-001:predict';
    
    let currentHtml = '';
    let generatedImages = {};
    let isDesktop = window.innerWidth >= 1024;

    const buildScreen = document.getElementById('buildScreen');
    const editorScreen = document.getElementById('editorScreen');
    const buildForm = document.getElementById('buildForm');
    const buildLoading = document.getElementById('buildLoading');
    const buildError = document.getElementById('buildError');
    const loadingText = document.getElementById('loadingText');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const messages = document.getElementById('messages');
    const previewFrame = document.getElementById('previewFrame');
    const previewPanel = document.getElementById('previewPanel');

    // Build initial site
    buildForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = document.getElementById('initialPrompt').value;
      
      buildForm.classList.add('hidden');
      buildLoading.classList.remove('hidden');
      buildLoading.classList.add('flex');
      
      try {
        // Step 1: Generate image descriptions
        loadingText.textContent = 'Planning images...';
        const imageDescs = await getImageDescriptions(prompt);
        
        // Step 2: Generate images with Imagen
        loadingText.textContent = `Generating ${imageDescs.length} images...`;
        const imageUrls = await generateImages(imageDescs, prompt);
        
        // Step 3: Generate HTML with the images
        loadingText.textContent = 'Building your site...';
        currentHtml = await generateSite(prompt, imageUrls);
        
        showEditor();
        addMessage('user', prompt);
        addMessage('assistant', `âœ¨ Your site is ready with ${imageDescs.length} custom AI-generated images! You can preview it and ask me to make changes.`);
        updatePreview();
      } catch (err) {
        buildLoading.classList.add('hidden');
        buildError.classList.remove('hidden');
        document.getElementById('buildErrorMsg').textContent = err.message;
      }
    });

    // Get image descriptions from Gemini
    async function getImageDescriptions(sitePrompt) {
      const prompt = `For a website described as: "${sitePrompt}"

List 2-3 images that would be needed. For each, provide a detailed image generation prompt.
Focus on: hero/banner image, and 1-2 supporting images.

Return ONLY a JSON array of strings, each being an image prompt. Example:
["A stunning mountain landscape at sunset with golden light", "Professional headshot of a person smiling"]

Be specific about style, lighting, composition. No text in images.`;

      const res = await fetch(`${GEMINI_API}?key=${GEMINI_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
        })
      });

      const data = await res.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
      const match = text.match(/\[[\s\S]*\]/);
      return match ? JSON.parse(match[0]).slice(0, 3) : ['Abstract modern background'];
    }

    // Generate images with Imagen
    async function generateImages(descriptions, context) {
      const results = [];
      
      for (let i = 0; i < descriptions.length; i++) {
        try {
          const res = await fetch(`${IMAGEN_API}?key=${GEMINI_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              instances: [{ prompt: descriptions[i] + '. High quality, professional photography style.' }],
              parameters: { sampleCount: 1 }
            })
          });

          const data = await res.json();
          if (data.predictions?.[0]?.bytesBase64Encoded) {
            results.push({
              description: descriptions[i],
              dataUrl: 'data:image/png;base64,' + data.predictions[0].bytesBase64Encoded
            });
          }
        } catch (err) {
          console.error('Image generation failed:', err);
        }
        
        loadingText.textContent = `Generating images (${i + 1}/${descriptions.length})...`;
      }
      
      // Fallback to picsum if no images generated
      if (results.length === 0) {
        results.push({ description: 'Hero', dataUrl: 'https://picsum.photos/1200/600' });
      }
      
      return results;
    }

    // Generate site with Gemini
    async function generateSite(prompt, images) {
      const imageList = images.map((img, i) => `Image ${i + 1}: ${img.dataUrl}`).join('\n');
      
      const sysPrompt = `You are a professional web developer. Generate a COMPLETE, beautiful HTML5 website.

REQUIREMENTS:
- Valid HTML5 with <!DOCTYPE html>
- Tailwind CSS via CDN: <script src="https://cdn.tailwindcss.com"><\/script>
- Inter font from Google Fonts  
- Mobile-first, fully responsive
- Modern, clean design
- Proper SEO meta tags

IMAGES TO USE (use these exact URLs in img src):
${imageList}

Use Image 1 as the hero/main image. Use others for sections like about, features, etc.

USER REQUEST: ${prompt}

IMPORTANT: The current year is ${new Date().getFullYear()}. Use this for any copyright notices.

OUTPUT: Generate ONLY the complete HTML file, no markdown or explanations.`;

      return await callGemini(sysPrompt);
    }

    // Edit site
    async function editSite(instruction, html) {
      const sysPrompt = `You are editing an existing website. Apply the user's requested changes.

CURRENT HTML:
${html}

USER REQUEST: ${instruction}

Keep existing images unless asked to change them.
IMPORTANT: The current year is ${new Date().getFullYear()}.

OUTPUT: Generate ONLY the complete updated HTML file, no markdown or explanations.`;

      return await callGemini(sysPrompt);
    }

    async function callGemini(prompt) {
      const res = await fetch(`${GEMINI_API}?key=${GEMINI_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
        })
      });

      if (!res.ok) throw new Error('API error: ' + res.status);
      const data = await res.json();
      let html = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      
      const match = html.match(/```(?:html)?\s*([\s\S]*?)```/);
      if (match) html = match[1];
      
      return html.trim();
    }

    // Chat handler
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;
      
      chatInput.value = '';
      addMessage('user', text);
      const thinkingId = addMessage('assistant', 'ðŸ¤” Thinking...');
      
      try {
        currentHtml = await editSite(text, currentHtml);
        updateMessage(thinkingId, 'âœ… Done! Check the preview.');
        updatePreview();
      } catch (err) {
        updateMessage(thinkingId, 'âŒ ' + err.message);
      }
    });

    function showEditor() {
      buildScreen.classList.add('hidden');
      editorScreen.classList.remove('hidden');
      editorScreen.classList.add('flex');
      if (isDesktop) previewPanel.classList.remove('hidden');
    }

    function addMessage(role, text) {
      const id = 'msg-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = role === 'user' 
        ? 'ml-auto max-w-[80%] bg-purple-600 text-white px-4 py-2 rounded-2xl rounded-br-md'
        : 'mr-auto max-w-[80%] bg-white border px-4 py-2 rounded-2xl rounded-bl-md shadow-sm';
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return id;
    }

    function updateMessage(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function updatePreview() {
      previewFrame.srcdoc = currentHtml;
      document.getElementById('mobilePreviewFrame').srcdoc = currentHtml;
    }

    document.getElementById('togglePreview').addEventListener('click', () => {
      if (isDesktop) {
        previewPanel.classList.toggle('hidden');
      } else {
        document.getElementById('mobilePreview').classList.remove('hidden');
      }
    });

    function closeMobilePreview() {
      document.getElementById('mobilePreview').classList.add('hidden');
    }

    document.getElementById('downloadSite').addEventListener('click', () => {
      const blob = new Blob([currentHtml], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'my-site.html';
      a.click();
    });

    function resetBuild() {
      buildForm.classList.remove('hidden');
      buildLoading.classList.add('hidden');
      buildError.classList.add('hidden');
    }

    window.addEventListener('resize', () => {
      isDesktop = window.innerWidth >= 1024;
      if (isDesktop && !editorScreen.classList.contains('hidden')) {
        previewPanel.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
