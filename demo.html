<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>needasite - Build & Edit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  
  <!-- Initial Build Screen -->
  <div id="buildScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="w-full max-w-lg">
      <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8">
        <div class="text-center mb-6">
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">needasite</h1>
          <p class="text-gray-500 mt-1">Describe it. We'll build it.</p>
        </div>

        <form id="buildForm" class="space-y-4">
          <textarea
            id="initialPrompt"
            rows="4"
            placeholder="Describe your website..."
            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
            required
          >A portfolio website for a photographer named Alex who specializes in landscape photography</textarea>
          <button type="submit" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition">
            Continue
          </button>
        </form>

        <div id="followUpSection" class="hidden space-y-4">
          <div id="followUpQuestion" class="p-4 bg-purple-50 rounded-xl text-gray-700"></div>
          <textarea id="followUpAnswer" rows="3" placeholder="Your answer..."
            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"></textarea>
          <div class="flex gap-2">
            <button id="skipFollowUp" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition">Skip</button>
            <button id="submitFollowUp" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition">Build Site</button>
          </div>
        </div>

        <div id="buildLoading" class="hidden flex-col items-center py-8">
          <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
          <p id="loadingText" class="text-gray-600">Building your site...</p>
        </div>

        <div id="buildError" class="hidden mt-6 p-4 bg-red-50 rounded-xl text-red-700">
          <span id="buildErrorMsg"></span>
          <button onclick="resetBuild()" class="mt-2 text-sm underline">Try again</button>
        </div>
      </div>
      <p class="text-center text-white/60 text-sm mt-6">Powered by AI</p>
    </div>
  </div>

  <!-- Editor Screen -->
  <div id="editorScreen" class="hidden min-h-screen flex flex-col">
    
    <!-- Top Bar -->
    <div class="bg-white border-b px-4 py-3 flex items-center justify-between">
      <h1 class="font-bold text-gray-900">needasite</h1>
      <div class="flex gap-2">
        <button id="downloadSite" class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200">
          ‚¨á Download
        </button>
        <button id="publishBtn" class="px-3 py-1.5 text-sm bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
          üöÄ Publish
        </button>
      </div>
    </div>

    <!-- Mobile Tab Bar -->
    <div class="lg:hidden flex border-b bg-white">
      <button id="tabChat" class="flex-1 py-3 text-center font-medium text-purple-600 border-b-2 border-purple-600">üí¨ Chat</button>
      <button id="tabPreview" class="flex-1 py-3 text-center font-medium text-gray-500 border-b-2 border-transparent">üëÅ Preview</button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
      <div id="chatPanel" class="flex-1 flex flex-col bg-gray-50 lg:max-w-md lg:border-r">
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <div class="p-4 bg-white border-t">
          <form id="chatForm" class="flex gap-2">
            <input type="text" id="chatInput" placeholder="Make the header blue..."
              class="flex-1 px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-medium">Send</button>
          </form>
        </div>
      </div>

      <div id="previewPanel" class="hidden lg:flex flex-1 flex-col bg-white">
        <iframe id="previewFrame" class="flex-1 border-0"></iframe>
      </div>
    </div>
  </div>

  <!-- Publish Modal -->
  <div id="publishModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
      <h2 class="text-xl font-bold text-gray-900 mb-2">Publish Your Site</h2>
      <p class="text-gray-500 mb-4">Enter your email to get your live site URL.</p>
      
      <form id="publishForm" class="space-y-4">
        <input type="email" id="publishEmail" placeholder="you@example.com" required
          class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        <div class="flex gap-2">
          <button type="button" id="cancelPublish" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition">Cancel</button>
          <button type="submit" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition">Publish</button>
        </div>
      </form>
      
      <div id="publishSuccess" class="hidden text-center py-4">
        <div class="text-4xl mb-2">üéâ</div>
        <p class="font-semibold text-gray-900 mb-2">Your site is live!</p>
        <a id="publishedUrl" href="#" target="_blank" class="text-purple-600 hover:text-purple-700 break-all"></a>
        <button onclick="closePublishModal()" class="mt-4 w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl">Done</button>
      </div>
    </div>
  </div>

  <script>
    const GEMINI_KEY = 'AIzaSyCt6kF7rVw--3CzfmmAuyTVYYzaNwrrKWY';
    const GEMINI_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
    
    // Feature flag - set to true to enable AI image generation
    const USE_AI_IMAGES = false;
    const IMAGEN_API = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-fast-generate-001:predict';
    
    let currentHtml = '';
    let userPrompt = '';
    let followUpContext = '';
    let isDesktop = window.innerWidth >= 1024;

    // Elements
    const buildScreen = document.getElementById('buildScreen');
    const editorScreen = document.getElementById('editorScreen');
    const buildForm = document.getElementById('buildForm');
    const followUpSection = document.getElementById('followUpSection');
    const buildLoading = document.getElementById('buildLoading');
    const loadingText = document.getElementById('loadingText');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const messages = document.getElementById('messages');
    const previewFrame = document.getElementById('previewFrame');
    const previewPanel = document.getElementById('previewPanel');
    const chatPanel = document.getElementById('chatPanel');
    const tabChat = document.getElementById('tabChat');
    const tabPreview = document.getElementById('tabPreview');

    // Tab switching
    tabChat?.addEventListener('click', () => {
      tabChat.classList.add('text-purple-600', 'border-purple-600');
      tabChat.classList.remove('text-gray-500', 'border-transparent');
      tabPreview.classList.remove('text-purple-600', 'border-purple-600');
      tabPreview.classList.add('text-gray-500', 'border-transparent');
      chatPanel.classList.remove('hidden');
      previewPanel.classList.add('hidden');
    });

    tabPreview?.addEventListener('click', () => {
      tabPreview.classList.add('text-purple-600', 'border-purple-600');
      tabPreview.classList.remove('text-gray-500', 'border-transparent');
      tabChat.classList.remove('text-purple-600', 'border-purple-600');
      tabChat.classList.add('text-gray-500', 'border-transparent');
      previewPanel.classList.remove('hidden');
      previewPanel.classList.add('flex');
      chatPanel.classList.add('hidden');
    });

    // Initial form submit
    buildForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      userPrompt = document.getElementById('initialPrompt').value.trim();
      if (userPrompt.length < 10) {
        alert('Please provide a more detailed description');
        return;
      }
      
      buildForm.classList.add('hidden');
      buildLoading.classList.remove('hidden');
      buildLoading.classList.add('flex');
      loadingText.textContent = 'Thinking...';
      
      try {
        let question = null;
        try {
          question = await getFollowUpQuestion(userPrompt);
        } catch (e) {
          console.log('Follow-up skipped:', e);
        }
        
        buildLoading.classList.add('hidden');
        
        if (question) {
          document.getElementById('followUpQuestion').textContent = question;
          followUpSection.classList.remove('hidden');
        } else {
          await buildSite();
        }
      } catch (err) {
        showBuildError(err.message);
      }
    });

    // Follow-up handlers
    document.getElementById('submitFollowUp').addEventListener('click', async () => {
      followUpContext = document.getElementById('followUpAnswer').value;
      followUpSection.classList.add('hidden');
      await buildSite();
    });

    document.getElementById('skipFollowUp').addEventListener('click', async () => {
      followUpSection.classList.add('hidden');
      await buildSite();
    });

    // Get follow-up question
    async function getFollowUpQuestion(prompt) {
      const sysPrompt = `A user wants to build a website: "${prompt}"

Ask ONE short clarifying question about color scheme, style, or key features.
If clear enough, respond: READY`;

      const text = await callGemini(sysPrompt);
      if (text.includes('READY') || text.length < 10) return null;
      return text;
    }

    // Build the site
    async function buildSite() {
      buildLoading.classList.remove('hidden');
      buildLoading.classList.add('flex');
      loadingText.textContent = 'Building your site...';
      
      const fullPrompt = followUpContext 
        ? `${userPrompt}\n\nAdditional details: ${followUpContext}`
        : userPrompt;
      
      try {
        currentHtml = await generateSite(fullPrompt);
        
        showEditor();
        addMessage('user', userPrompt);
        if (followUpContext) addMessage('user', followUpContext);
        addMessage('assistant', '‚ú® Your site is ready! Switch to Preview to see it, or ask me to make changes.');
        updatePreview();
      } catch (err) {
        showBuildError(err.message);
      }
    }

    // Generate site HTML (using stock images)
    async function generateSite(prompt) {
      const sysPrompt = `You are a professional web developer. Generate a COMPLETE, beautiful HTML5 website.

REQUIREMENTS:
- Valid HTML5 with <!DOCTYPE html>
- Tailwind CSS via CDN: <script src="https://cdn.tailwindcss.com"><\/script>
- Inter font from Google Fonts
- Mobile-first, fully responsive
- Modern, clean design
- Use placeholder images from https://picsum.photos/ (e.g., https://picsum.photos/800/600)
- Proper SEO meta tags
- Current year: ${new Date().getFullYear()}

USER REQUEST: ${prompt}

OUTPUT: Complete HTML only, no markdown or explanations.`;

      return await callGemini(sysPrompt);
    }

    // Edit site
    async function editSite(instruction, html) {
      const sysPrompt = `Edit this website per user request.

CURRENT HTML:
${html}

USER REQUEST: ${instruction}

Current year: ${new Date().getFullYear()}.

OUTPUT: Complete updated HTML only, no markdown.`;

      return await callGemini(sysPrompt);
    }

    // Gemini API call
    async function callGemini(prompt) {
      const res = await fetch(`${GEMINI_API}?key=${GEMINI_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
        })
      });

      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error?.message || `API error: ${res.status}`);
      }
      
      const data = await res.json();
      let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const match = text.match(/```(?:html)?\s*([\s\S]*?)```/);
      if (match) text = match[1];
      return text.trim();
    }

    // Chat handler
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;
      
      chatInput.value = '';
      addMessage('user', text);
      const thinkingId = addMessage('assistant', 'ü§î Updating...');
      
      try {
        currentHtml = await editSite(text, currentHtml);
        updateMessage(thinkingId, '‚úÖ Done! Check the Preview tab.');
        updatePreview();
      } catch (err) {
        updateMessage(thinkingId, '‚ùå ' + err.message);
      }
    });

    // UI helpers
    function showBuildError(msg) {
      buildLoading.classList.add('hidden');
      document.getElementById('buildError').classList.remove('hidden');
      document.getElementById('buildErrorMsg').textContent = msg;
    }

    function resetBuild() {
      buildForm.classList.remove('hidden');
      buildLoading.classList.add('hidden');
      document.getElementById('buildError').classList.add('hidden');
      followUpSection.classList.add('hidden');
    }

    function showEditor() {
      buildScreen.classList.add('hidden');
      editorScreen.classList.remove('hidden');
      editorScreen.classList.add('flex');
      if (isDesktop) {
        previewPanel.classList.remove('hidden');
        previewPanel.classList.add('flex');
      }
    }

    function addMessage(role, text) {
      const id = 'msg-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = role === 'user' 
        ? 'ml-auto max-w-[80%] bg-purple-600 text-white px-4 py-2 rounded-2xl rounded-br-md'
        : 'mr-auto max-w-[80%] bg-white border px-4 py-2 rounded-2xl rounded-bl-md shadow-sm';
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return id;
    }

    function updateMessage(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function updatePreview() {
      previewFrame.srcdoc = currentHtml;
    }

    // Download
    document.getElementById('downloadSite').addEventListener('click', () => {
      const blob = new Blob([currentHtml], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'my-site.html';
      a.click();
    });

    // Publish modal
    document.getElementById('publishBtn').addEventListener('click', () => {
      document.getElementById('publishModal').classList.remove('hidden');
      document.getElementById('publishForm').classList.remove('hidden');
      document.getElementById('publishSuccess').classList.add('hidden');
    });

    document.getElementById('cancelPublish').addEventListener('click', closePublishModal);

    document.getElementById('publishForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('publishEmail').value;
      
      // TODO: Actually publish the site and save email
      // For now, simulate success
      const siteId = Math.random().toString(36).substring(2, 10);
      const url = `https://${siteId}.needasite.com`;
      
      document.getElementById('publishForm').classList.add('hidden');
      document.getElementById('publishSuccess').classList.remove('hidden');
      document.getElementById('publishedUrl').href = url;
      document.getElementById('publishedUrl').textContent = url;
      
      console.log('Publish requested:', { email, siteId, htmlLength: currentHtml.length });
    });

    function closePublishModal() {
      document.getElementById('publishModal').classList.add('hidden');
    }

    // Resize handler
    window.addEventListener('resize', () => {
      isDesktop = window.innerWidth >= 1024;
    });

    // === AI IMAGE GENERATION (disabled for now) ===
    async function generateImagesAI(descriptions) {
      if (!USE_AI_IMAGES) return [];
      
      const results = [];
      for (const desc of descriptions.slice(0, 3)) {
        try {
          const res = await fetch(`${IMAGEN_API}?key=${GEMINI_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              instances: [{ prompt: desc + '. High quality photography.' }],
              parameters: { sampleCount: 1 }
            })
          });
          const data = await res.json();
          if (data.predictions?.[0]?.bytesBase64Encoded) {
            results.push('data:image/png;base64,' + data.predictions[0].bytesBase64Encoded);
          }
        } catch (err) {
          console.error('Image gen failed:', err);
        }
      }
      return results;
    }
  </script>
</body>
</html>
