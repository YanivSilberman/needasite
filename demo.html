<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>needasite - Build & Edit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  
  <!-- Initial Build Screen -->
  <div id="buildScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
    <div class="w-full max-w-lg">
      <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8">
        <div class="text-center mb-6">
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">needasite</h1>
          <p class="text-gray-500 mt-1">Describe it. We'll build it.</p>
        </div>

        <!-- Initial prompt form -->
        <form id="buildForm" class="space-y-4">
          <textarea
            id="initialPrompt"
            rows="4"
            placeholder="Describe your website..."
            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
            required
          >A portfolio website for a photographer named Alex who specializes in landscape photography</textarea>
          <button type="submit" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition">
            Continue
          </button>
        </form>

        <!-- Follow-up questions -->
        <div id="followUpSection" class="hidden space-y-4">
          <div id="followUpQuestion" class="p-4 bg-purple-50 rounded-xl text-gray-700"></div>
          <textarea
            id="followUpAnswer"
            rows="3"
            placeholder="Your answer..."
            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
          ></textarea>
          <div class="flex gap-2">
            <button id="skipFollowUp" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition">
              Skip
            </button>
            <button id="submitFollowUp" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition">
              Build Site
            </button>
          </div>
        </div>

        <!-- Loading -->
        <div id="buildLoading" class="hidden flex-col items-center py-8">
          <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
          <p id="loadingText" class="text-gray-600">Building your site...</p>
          <p class="text-gray-400 text-sm mt-1">~30 seconds</p>
        </div>

        <!-- Error -->
        <div id="buildError" class="hidden mt-6 p-4 bg-red-50 rounded-xl text-red-700">
          <span id="buildErrorMsg"></span>
          <button onclick="resetBuild()" class="mt-2 text-sm underline">Try again</button>
        </div>
      </div>
      <p class="text-center text-white/60 text-sm mt-6">Powered by Gemini + Imagen</p>
    </div>
  </div>

  <!-- Editor Screen -->
  <div id="editorScreen" class="hidden min-h-screen flex flex-col">
    
    <!-- Top Bar -->
    <div class="bg-white border-b px-4 py-3 flex items-center justify-between">
      <h1 class="font-bold text-gray-900">needasite</h1>
      <div class="flex gap-2">
        <button id="downloadSite" class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200">
          ‚¨á Download
        </button>
      </div>
    </div>

    <!-- Main Content - Tab based on mobile -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
      
      <!-- Mobile Tab Bar -->
      <div class="lg:hidden flex border-b bg-white">
        <button id="tabChat" class="flex-1 py-3 text-center font-medium text-purple-600 border-b-2 border-purple-600">
          üí¨ Chat
        </button>
        <button id="tabPreview" class="flex-1 py-3 text-center font-medium text-gray-500 border-b-2 border-transparent">
          üëÅ Preview
        </button>
      </div>

      <!-- Chat Panel -->
      <div id="chatPanel" class="flex-1 flex flex-col bg-gray-50 lg:max-w-md lg:border-r">
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <div class="p-4 bg-white border-t">
          <form id="chatForm" class="flex gap-2">
            <input type="text" id="chatInput" placeholder="Make the header blue..."
              class="flex-1 px-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-medium">Send</button>
          </form>
        </div>
      </div>

      <!-- Preview Panel -->
      <div id="previewPanel" class="hidden lg:flex flex-1 flex-col bg-white">
        <iframe id="previewFrame" class="flex-1 border-0"></iframe>
      </div>
    </div>
  </div>

  <script>
    const GEMINI_KEY = 'AIzaSyCt6kF7rVw--3CzfmmAuyTVYYzaNwrrKWY';
    const GEMINI_API = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
    const IMAGEN_API = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-fast-generate-001:predict';
    
    let currentHtml = '';
    let userPrompt = '';
    let followUpContext = '';
    let isDesktop = window.innerWidth >= 1024;

    const buildScreen = document.getElementById('buildScreen');
    const editorScreen = document.getElementById('editorScreen');
    const buildForm = document.getElementById('buildForm');
    const followUpSection = document.getElementById('followUpSection');
    const buildLoading = document.getElementById('buildLoading');
    const buildError = document.getElementById('buildError');
    const loadingText = document.getElementById('loadingText');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const messages = document.getElementById('messages');
    const previewFrame = document.getElementById('previewFrame');
    const previewPanel = document.getElementById('previewPanel');
    const chatPanel = document.getElementById('chatPanel');

    // Tab switching for mobile
    const tabChat = document.getElementById('tabChat');
    const tabPreview = document.getElementById('tabPreview');

    tabChat?.addEventListener('click', () => {
      tabChat.classList.add('text-purple-600', 'border-purple-600');
      tabChat.classList.remove('text-gray-500', 'border-transparent');
      tabPreview.classList.remove('text-purple-600', 'border-purple-600');
      tabPreview.classList.add('text-gray-500', 'border-transparent');
      chatPanel.classList.remove('hidden');
      previewPanel.classList.add('hidden');
    });

    tabPreview?.addEventListener('click', () => {
      tabPreview.classList.add('text-purple-600', 'border-purple-600');
      tabPreview.classList.remove('text-gray-500', 'border-transparent');
      tabChat.classList.remove('text-purple-600', 'border-purple-600');
      tabChat.classList.add('text-gray-500', 'border-transparent');
      previewPanel.classList.remove('hidden');
      previewPanel.classList.add('flex');
      chatPanel.classList.add('hidden');
    });

    // Step 1: Get initial prompt and ask follow-up
    buildForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      userPrompt = document.getElementById('initialPrompt').value.trim();
      
      if (userPrompt.length < 10) {
        alert('Please provide a more detailed description (at least 10 characters)');
        return;
      }
      
      buildForm.classList.add('hidden');
      buildLoading.classList.remove('hidden');
      buildLoading.classList.add('flex');
      loadingText.textContent = 'Thinking...';
      
      try {
        let question = null;
        try {
          question = await getFollowUpQuestion(userPrompt);
        } catch (e) {
          console.log('Follow-up question failed, proceeding to build:', e);
        }
        
        buildLoading.classList.add('hidden');
        
        if (question) {
          document.getElementById('followUpQuestion').textContent = question;
          followUpSection.classList.remove('hidden');
        } else {
          await buildSite();
        }
      } catch (err) {
        showBuildError(err.message);
      }
    });

    // Get follow-up question from Gemini
    async function getFollowUpQuestion(prompt) {
      const sysPrompt = `A user wants to build a website. They said: "${prompt}"

If you need ONE important clarification to build a better site, ask it now. 
Focus on: color preferences, specific content, style preferences, or key features.

If the request is already clear enough, respond with just: READY

Otherwise respond with just the question (no intro, no "I'd like to ask", just the question).`;

      const text = await callGemini(sysPrompt);
      if (text.includes('READY') || text.length < 10) return null;
      return text;
    }

    // Handle follow-up answer
    document.getElementById('submitFollowUp').addEventListener('click', async () => {
      followUpContext = document.getElementById('followUpAnswer').value;
      followUpSection.classList.add('hidden');
      await buildSite();
    });

    document.getElementById('skipFollowUp').addEventListener('click', async () => {
      followUpSection.classList.add('hidden');
      await buildSite();
    });

    // Build the site
    async function buildSite() {
      buildLoading.classList.remove('hidden');
      buildLoading.classList.add('flex');
      
      // Ensure prompts are clean strings
      const safeUserPrompt = String(userPrompt || '').slice(0, 2000);
      const safeFollowUp = String(followUpContext || '').slice(0, 2000);
      
      const fullPrompt = safeFollowUp 
        ? `${safeUserPrompt}\n\nAdditional details: ${safeFollowUp}`
        : safeUserPrompt;
        
      console.log('=== BUILD SITE ===');
      console.log('userPrompt length:', safeUserPrompt.length);
      console.log('followUpContext length:', safeFollowUp.length);
      console.log('fullPrompt length:', fullPrompt.length);
      
      try {
        // Step 1: Generate image descriptions
        loadingText.textContent = 'Planning images...';
        const imageDescs = await getImageDescriptions(fullPrompt);
        
        // Step 2: Generate images
        loadingText.textContent = `Generating ${imageDescs.length} images...`;
        const imageUrls = await generateImages(imageDescs);
        
        // Step 3: Generate HTML
        loadingText.textContent = 'Building your site...';
        currentHtml = await generateSite(fullPrompt, imageUrls);
        
        showEditor();
        addMessage('user', userPrompt);
        if (followUpContext) {
          addMessage('user', followUpContext);
        }
        addMessage('assistant', `‚ú® Your site is ready with ${imageUrls.length} custom AI-generated images! Switch to Preview tab to see it, or ask me to make changes.`);
        updatePreview();
      } catch (err) {
        showBuildError(err.message);
      }
    }

    function showBuildError(msg) {
      buildLoading.classList.add('hidden');
      buildError.classList.remove('hidden');
      document.getElementById('buildErrorMsg').textContent = msg;
    }

    // Get image descriptions
    async function getImageDescriptions(sitePrompt) {
      const prompt = `For a website described as: "${sitePrompt}"

List 2-3 images needed. For each, provide a detailed image generation prompt.
Focus on: hero/banner image, and 1-2 supporting images.

Return ONLY a JSON array of strings. Example:
["A stunning mountain landscape at sunset", "Professional headshot with neutral background"]

Be specific about style, lighting, composition. No text in images.`;

      const text = await callGemini(prompt);
      const match = text.match(/\[[\s\S]*\]/);
      return match ? JSON.parse(match[0]).slice(0, 3) : ['Abstract modern background'];
    }

    // Generate images
    async function generateImages(descriptions) {
      const results = [];
      
      // Limit descriptions to reasonable length
      const safeDescriptions = descriptions.map(d => 
        typeof d === 'string' ? d.slice(0, 500) : 'Abstract background'
      );
      
      for (let i = 0; i < safeDescriptions.length; i++) {
        loadingText.textContent = `Generating image ${i + 1}/${safeDescriptions.length}...`;
        try {
          const imagePrompt = safeDescriptions[i] + '. High quality, professional photography.';
          console.log(`Image ${i + 1} prompt (${imagePrompt.length} chars):`, imagePrompt.slice(0, 100));
          
          const res = await fetch(`${IMAGEN_API}?key=${GEMINI_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              instances: [{ prompt: imagePrompt }],
              parameters: { sampleCount: 1 }
            })
          });

          const data = await res.json();
          if (data.error) {
            console.error('Imagen error:', data.error);
            continue;
          }
          if (data.predictions?.[0]?.bytesBase64Encoded) {
            results.push({
              description: safeDescriptions[i],
              dataUrl: 'data:image/png;base64,' + data.predictions[0].bytesBase64Encoded
            });
          }
        } catch (err) {
          console.error('Image failed:', err);
        }
      }
      
      if (results.length === 0) {
        results.push({ description: 'Hero', dataUrl: 'https://picsum.photos/1200/600' });
      }
      
      return results;
    }

    // Generate site HTML
    async function generateSite(prompt, images) {
      console.log('generateSite called');
      console.log('Prompt length:', prompt.length);
      console.log('Images count:', images.length);
      
      // Create placeholder references - ONLY use descriptions, never data URLs!
      const imagePlaceholders = images.map((img, i) => {
        const desc = (img.description || 'Image').slice(0, 200);
        console.log(`Image ${i+1} desc:`, desc.slice(0, 50));
        return `{{IMAGE_${i + 1}}} - ${desc}`;
      }).join('\n');
      
      console.log('Image placeholders total length:', imagePlaceholders.length);
      
      const sysPrompt = `You are a professional web developer. Generate a COMPLETE, beautiful HTML5 website.

REQUIREMENTS:
- Valid HTML5 with <!DOCTYPE html>
- Tailwind CSS via CDN: <script src="https://cdn.tailwindcss.com"><\/script>
- Inter font from Google Fonts  
- Mobile-first, fully responsive
- Modern, clean design
- Proper SEO meta tags

IMAGES: Use these placeholders in img src attributes (they will be replaced with real images):
${imagePlaceholders}

Example: <img src="{{IMAGE_1}}" alt="...">

Use {{IMAGE_1}} as hero. Use others for about/features sections.

USER REQUEST: ${prompt}

Current year: ${new Date().getFullYear()}

OUTPUT: Complete HTML only, no markdown.`;

      let html = await callGemini(sysPrompt);
      
      // Replace placeholders with actual data URLs
      images.forEach((img, i) => {
        html = html.replace(new RegExp(`\\{\\{IMAGE_${i + 1}\\}\\}`, 'g'), img.dataUrl);
      });
      
      return html;
    }

    // Store images separately for editing
    let storedImages = [];
    
    // Edit site
    async function editSite(instruction, html) {
      console.log('editSite called, HTML length:', html.length);
      
      // Replace data URLs with placeholders to reduce token count
      let htmlWithPlaceholders = html;
      const dataUrlPattern = /data:image\/[^;]+;base64,[A-Za-z0-9+/=]+/g;
      const dataUrls = html.match(dataUrlPattern) || [];
      console.log('Found', dataUrls.length, 'data URLs to replace');
      
      dataUrls.forEach((url, i) => {
        htmlWithPlaceholders = htmlWithPlaceholders.replace(url, `{{EXISTING_IMAGE_${i + 1}}}`);
      });
      
      const sysPrompt = `Edit this website per user request.

CURRENT HTML:
${htmlWithPlaceholders}

Note: {{EXISTING_IMAGE_X}} are placeholders for existing images - keep them as-is unless asked to change.

USER REQUEST: ${instruction}

Current year: ${new Date().getFullYear()}.

OUTPUT: Complete updated HTML only, no markdown.`;

      let newHtml = await callGemini(sysPrompt);
      
      // Restore data URLs
      dataUrls.forEach((url, i) => {
        newHtml = newHtml.replace(new RegExp(`\\{\\{EXISTING_IMAGE_${i + 1}\\}\\}`, 'g'), url);
      });
      
      return newHtml;
    }

    async function callGemini(prompt) {
      // Safety check - prompts should never be huge
      console.log('=== GEMINI CALL ===');
      console.log('Prompt length:', prompt.length, 'chars');
      console.log('Prompt preview:', prompt.slice(0, 300));
      
      if (prompt.length > 50000) {
        console.error('PROMPT TOO LARGE:', prompt.length, 'chars');
        throw new Error(`Prompt too large (${prompt.length} chars). This is a bug.`);
      }
      
      const body = {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
      };
      const bodyStr = JSON.stringify(body);
      console.log('Request body length:', bodyStr.length, 'chars');
      
      if (bodyStr.length > 100000) {
        console.error('BODY TOO LARGE:', bodyStr.length);
        throw new Error(`Request body too large (${bodyStr.length} chars)`);
      }
      
      const res = await fetch(`${GEMINI_API}?key=${GEMINI_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: bodyStr
      });

      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        const errMsg = errData.error?.message || `API error: ${res.status}`;
        console.error('Gemini error:', errData);
        throw new Error(errMsg);
      }
      const data = await res.json();
      let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      
      const match = text.match(/```(?:html)?\s*([\s\S]*?)```/);
      if (match) text = match[1];
      
      return text.trim();
    }

    // Chat handler
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;
      
      chatInput.value = '';
      addMessage('user', text);
      const thinkingId = addMessage('assistant', 'ü§î Updating...');
      
      try {
        currentHtml = await editSite(text, currentHtml);
        updateMessage(thinkingId, '‚úÖ Done! Check the Preview tab.');
        updatePreview();
      } catch (err) {
        updateMessage(thinkingId, '‚ùå ' + err.message);
      }
    });

    function showEditor() {
      buildScreen.classList.add('hidden');
      editorScreen.classList.remove('hidden');
      editorScreen.classList.add('flex');
      
      if (isDesktop) {
        previewPanel.classList.remove('hidden');
        previewPanel.classList.add('flex');
      }
    }

    function addMessage(role, text) {
      const id = 'msg-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = role === 'user' 
        ? 'ml-auto max-w-[80%] bg-purple-600 text-white px-4 py-2 rounded-2xl rounded-br-md'
        : 'mr-auto max-w-[80%] bg-white border px-4 py-2 rounded-2xl rounded-bl-md shadow-sm';
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return id;
    }

    function updateMessage(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function updatePreview() {
      previewFrame.srcdoc = currentHtml;
    }

    document.getElementById('downloadSite').addEventListener('click', () => {
      const blob = new Blob([currentHtml], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'my-site.html';
      a.click();
    });

    function resetBuild() {
      buildForm.classList.remove('hidden');
      buildLoading.classList.add('hidden');
      buildError.classList.add('hidden');
      followUpSection.classList.add('hidden');
    }

    window.addEventListener('resize', () => {
      isDesktop = window.innerWidth >= 1024;
    });
  </script>
</body>
</html>
